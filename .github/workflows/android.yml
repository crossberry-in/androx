name: APK Build

on:
  push:
    branches:
      - master
      - main
      - develop
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  build_apk:
    name: Build APK - ${{ matrix.package_variant }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        package_variant: [apt-android-7, apt-android-5]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for versioning

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
        continue-on-error: false

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build APK
        id: build
        env:
          TERMUX_PACKAGE_VARIANT: ${{ matrix.package_variant }}
        run: |
          echo "ðŸ”¨ Building Androx APK with ${TERMUX_PACKAGE_VARIANT}"
          
          # Get current version from build.gradle
          VERSION_NAME=$(grep -m1 'versionName' app/build.gradle | awk -F'"' '{print $2}')
          VERSION_CODE=$(grep -m1 'versionCode' app/build.gradle | awk '{print $2}')
          
          # Get short commit hash
          COMMIT_HASH=$(git rev-parse --short HEAD)
          
          # Create version tag
          VERSION_TAG="v${VERSION_NAME}+${COMMIT_HASH}-${TERMUX_PACKAGE_VARIANT}"
          APK_NAME="androx-${VERSION_TAG}"
          
          echo "VERSION_NAME=${VERSION_NAME}" >> $GITHUB_ENV
          echo "VERSION_CODE=${VERSION_CODE}" >> $GITHUB_ENV
          echo "VERSION_TAG=${VERSION_TAG}" >> $GITHUB_ENV
          echo "APK_NAME=${APK_NAME}" >> $GITHUB_ENV
          
          # Build APKs
          ./gradlew assembleDebug \
            -PversionName="${VERSION_NAME}" \
            -PversionCode="${VERSION_CODE}"
          
          echo "âœ… Build completed: ${APK_NAME}"

      - name: Rename APKs
        run: |
          APK_DIR="./app/build/outputs/apk/debug"
          
          # Rename all APKs with proper naming
          for apk in "${APK_DIR}"/*.apk; do
            if [ -f "$apk" ]; then
              filename=$(basename "$apk")
              # Extract architecture from filename
              if [[ $filename == *universal* ]]; then
                arch="universal"
              elif [[ $filename == *arm64-v8a* ]]; then
                arch="arm64-v8a"
              elif [[ $filename == *armeabi-v7a* ]]; then
                arch="armeabi-v7a"
              elif [[ $filename == *x86_64* ]]; then
                arch="x86_64"
              elif [[ $filename == *x86* ]]; then
                arch="x86"
              fi
              
              mv "$apk" "${APK_DIR}/${{ env.APK_NAME }}-${arch}.apk"
            fi
          done
          
          ls -lh "${APK_DIR}/"

      - name: Generate checksums
        run: |
          APK_DIR="./app/build/outputs/apk/debug"
          cd "${APK_DIR}"
          
          if ls *.apk 1> /dev/null 2>&1; then
            sha256sum *.apk > SHA256SUMS.txt
            md5sum *.apk > MD5SUMS.txt
            echo "ðŸ“‹ Checksums generated"
          else
            echo "âš ï¸ No APKs found to generate checksums"
            exit 1
          fi

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: androx-${{ env.VERSION_TAG }}
          path: |
            ./app/build/outputs/apk/debug/*.apk
            ./app/build/outputs/apk/debug/*SUMS.txt
          retention-days: 30
          if-no-files-found: error

      - name: Upload build summary
        uses: actions/upload-artifact@v4
        with:
          name: build-info-${{ matrix.package_variant }}
          path: |
            ./app/build/outputs/apk/debug/output-metadata.json
          retention-days: 30

      - name: Generate build report
        run: |
          echo "## ðŸ“± Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **App Name**: Androx" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ env.VERSION_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Variant**: ${{ matrix.package_variant }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: $(git rev-parse --short HEAD)" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Tag**: ${{ env.VERSION_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ APKs Built" >> $GITHUB_STEP_SUMMARY
          ls -lh ./app/build/outputs/apk/debug/*.apk >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  download_all:
    name: Combined APK Package
    runs-on: ubuntu-latest
    needs: build_apk
    if: always()
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: ./apks
      
      - name: Create combined package
        run: |
          mkdir -p release-package
          find ./apks -name "*.apk" -exec cp {} release-package/ \;
          find ./apks -name "*SUMS.txt" -exec cp {} release-package/ \;
          
          echo "## ðŸ“¦ Combined APK Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All APK configurations have been combined." >> $GITHUB_STEP_SUMMARY
          ls -lh release-package/ >> $GITHUB_STEP_SUMMARY
      
      - name: Upload combined package
        uses: actions/upload-artifact@v4
        with:
          name: androx-complete-package
          path: ./release-package/*
          retention-days: 30
